From 91b7dfd29314c98a18b2f3ad5663488e512b38cc Mon Sep 17 00:00:00 2001
From: Cezary Sobczak <cezary.sobczak@3mdeb.com>
Date: Thu, 24 Mar 2022 00:10:00 +0100
Subject: [PATCH 2/2] riscv: fix build with binutils 2.38

From version 2.38, binutils default to ISA spec version 20191213. This
means that the csr read/write (csrr*/csrw*) instructions and fence.i
instruction has separated from the `I` extension, become two standalone
extensions: Zicsr and Zifencei.

The fix is to specify those extensions explicitely in -march. However as
older binutils version do not support this, we first need to detect
that.

Fixes:
	mmu.c: Assembler messages:
	mmu.c:85: Error: unrecognized opcode `fence.i'

Signed-off-by: Cezary Sobczak <cezary.sobczak@3mdeb.com>
---
 mk/config.mk | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/mk/config.mk b/mk/config.mk
index a42f06f385fc..d4215cb0421e 100644
--- a/mk/config.mk
+++ b/mk/config.mk
@@ -48,6 +48,11 @@ SPLINCLUDE    := \
 	-fno-delete-null-pointer-checks \
 	-pipe
 
+# Newer binutils versions default to ISA spec version 20191213 which moves some
+# instructions from the I extension to the Zicsr and Zifencei extensions.
+toolchain-need-zicsr-zifencei := $(call cc-option-yn, -march=$(ARCH_BASE)$(ARCH_A)$(ARCH_F)$(ARCH_D)$(ARCH_C)_zicsr_zifencei)
+zicsr_zifencei-$(toolchain-need-zicsr-zifencei) := _zicsr_zifencei
+
 else
 
 ifeq ($(CFG_SUNXI_USE_NEON),y)
-- 
2.25.1

